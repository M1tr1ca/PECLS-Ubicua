<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>  
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <title>Panel de Control IoT - Sensores Ambientales</title>
        <style>
            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --warning-color: #f59e0b;
                --danger-color: #ef4444;
                --info-color: #3b82f6;
                --dark-color: #1f2937;
                --light-bg: #f8fafc;
                --card-bg: #ffffff;
                --border-color: #e2e8f0;
                --text-primary: #1e293b;
                --text-secondary: #64748b;
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: var(--text-primary);
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            /* Header */
            .header {
                background: var(--card-bg);
                border-radius: 16px;
                padding: 24px 32px;
                margin-bottom: 24px;
                box-shadow: var(--shadow-lg);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .logo {
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, var(--primary-color), #7c3aed);
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 24px;
            }

            .header h1 {
                font-size: 1.75rem;
                font-weight: 700;
                color: var(--text-primary);
            }

            .header p {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .status-container {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .status-badge {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 16px;
                background: #ecfdf5;
                border-radius: 9999px;
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--success-color);
                cursor: pointer;
                transition: all 0.2s;
            }

            .status-badge:hover {
                transform: scale(1.02);
            }

            .status-badge.warning {
                background: #fef3c7;
                color: #d97706;
            }

            .status-badge.error {
                background: #fecaca;
                color: #dc2626;
            }

            .status-badge.checking {
                background: #e0e7ff;
                color: #4f46e5;
            }

            .status-dot {
                width: 8px;
                height: 8px;
                background: var(--success-color);
                border-radius: 50%;
                animation: pulse 2s infinite;
            }

            .status-dot.warning {
                background: #d97706;
            }

            .status-dot.error {
                background: #dc2626;
                animation: none;
            }

            .status-dot.checking {
                background: #4f46e5;
            }

            .status-details {
                display: flex;
                gap: 6px;
            }

            .status-item {
                display: flex;
                align-items: center;
                gap: 4px;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 0.75rem;
                font-weight: 500;
            }

            .status-item.ok {
                background: #d1fae5;
                color: #065f46;
            }

            .status-item.fail {
                background: #fecaca;
                color: #991b1b;
            }

            .status-item i {
                font-size: 0.7rem;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            .btn-refresh {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-refresh:hover {
                background: var(--primary-hover);
                transform: translateY(-1px);
            }

            /* Stats Cards */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .stat-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 20px;
                box-shadow: var(--shadow-md);
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .stat-card .icon {
                width: 44px;
                height: 44px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                margin-bottom: 12px;
            }

            .stat-card.temp .icon { background: #fef3c7; color: #d97706; }
            .stat-card.humidity .icon { background: #dbeafe; color: #2563eb; }
            .stat-card.pressure .icon { background: #ede9fe; color: #7c3aed; }
            .stat-card.altitude .icon { background: #d1fae5; color: #059669; }

            .stat-card .label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-secondary);
                font-weight: 600;
                margin-bottom: 4px;
            }

            .stat-card .value {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--text-primary);
            }

            .stat-card .sub {
                font-size: 0.75rem;
                color: var(--text-secondary);
                margin-top: 4px;
            }

            /* Main Grid */
            .main-grid {
                display: grid;
                grid-template-columns: 1fr 320px;
                gap: 24px;
                align-items: start;
            }

            /* Make the main data table card span the full width of the layout (both columns)
               so it appears as wide as the header / stats cards above. */
            .main-grid .table-card {
                grid-column: 1 / -1;
                width: 100%;
                max-width: 100%;
            }

            /* Slightly larger title for emphasis in the table card */
            .main-grid .table-card .card-header .card-title {
                font-size: 1.65rem;
            }

            /* Make the table card header a bit taller and match spacing of top banner */
            .main-grid .table-card .card-header {
                padding: 28px 32px;
                min-height: 72px;
            }

            @media (max-width: 1280px) {
                .main-grid {
                    grid-template-columns: 1fr;
                }
            }

            /* Card */
            .card {
                background: var(--card-bg);
                border-radius: 16px;
                box-shadow: var(--shadow-md);
                overflow: hidden;
            }

            .card-header {
                padding: 20px 24px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 12px;
            }

            .card-title {
                font-size: 1.125rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .card-title i {
                color: var(--primary-color);
            }

            .card-body {
                padding: 24px;
            }

            /* Filters */
            .filters-section {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .filter-group label {
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--text-secondary);
            }

            .filter-select, .filter-input {
                padding: 8px 12px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                font-size: 0.875rem;
                background: var(--light-bg);
                color: var(--text-primary);
                transition: border-color 0.2s, box-shadow 0.2s;
            }

            .filter-select:focus, .filter-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            }

            .btn-filter {
                padding: 8px 16px;
                background: var(--light-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .btn-filter:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .btn-filter.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            /* Table */
            .table-container {
                overflow-x: auto;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.875rem;
            }

            thead {
                background: var(--light-bg);
            }

            th {
                padding: 14px 16px;
                text-align: left;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                font-size: 0.75rem;
                letter-spacing: 0.05em;
                border-bottom: 2px solid var(--border-color);
                cursor: pointer;
                transition: background 0.2s;
                white-space: nowrap;
            }

            th:hover {
                background: #e2e8f0;
            }

            th i {
                margin-left: 6px;
                opacity: 0.5;
            }

            td {
                padding: 14px 16px;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-primary);
            }

            tr:hover {
                background: #f8fafc;
            }

            .sensor-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 4px 10px;
                background: #ede9fe;
                color: #7c3aed;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.8rem;
            }

            .temp-value {
                font-weight: 600;
                color: #d97706;
            }

            .temp-high { color: #dc2626; }
            .temp-low { color: #2563eb; }

            .humidity-value { color: #2563eb; font-weight: 500; }
            .pressure-value { color: #7c3aed; font-weight: 500; }
            .altitude-value { color: #059669; font-weight: 500; }

            /* Alert Controls */
            .alert-section {
                margin-bottom: 20px;
            }

            .alert-title {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 12px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .alert-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }

            .btn-alert {
                padding: 12px 8px;
                border: none;
                border-radius: 10px;
                font-size: 0.75rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .btn-alert:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .btn-alert.level-0 { background: #d1fae5; color: #065f46; }
            .btn-alert.level-0:hover { background: #a7f3d0; }
            .btn-alert.level-1 { background: #dbeafe; color: #1e40af; }
            .btn-alert.level-1:hover { background: #bfdbfe; }
            .btn-alert.level-2 { background: #fef3c7; color: #92400e; }
            .btn-alert.level-2:hover { background: #fde68a; }
            .btn-alert.level-3 { background: #fed7aa; color: #9a3412; }
            .btn-alert.level-3:hover { background: #fdba74; }
            .btn-alert.level-4 { background: #fecaca; color: #991b1b; }
            .btn-alert.level-4:hover { background: #fca5a5; }

            .btn-alert.active {
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
                transform: scale(1.05);
            }

            .btn-sensor-type {
                font-size: 0.85rem;
                padding: 14px 10px;
            }

            .btn-alert i {
                font-size: 1.25rem;
            }

            .btn-reset {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #64748b, #475569);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 0.875rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                margin-top: 16px;
            }

            .btn-reset:hover {
                background: linear-gradient(135deg, #475569, #334155);
                transform: translateY(-1px);
            }

            #commandStatus {
                margin-top: 12px;
                padding: 10px;
                border-radius: 8px;
                text-align: center;
                font-size: 0.875rem;
                min-height: 40px;
            }

            #commandStatus:not(:empty) {
                background: #f0fdf4;
            }

            /* Input Section */
            .input-section {
                background: var(--light-bg);
                border-radius: 12px;
                padding: 16px;
                margin-top: 16px;
            }

            .input-section label {
                display: block;
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 8px;
            }

            .input-group {
                display: flex;
                gap: 8px;
            }

            .input-group input, .input-group textarea {
                flex: 1;
                padding: 12px 16px;
                border: 1px solid var(--border-color);
                border-radius: 10px;
                font-size: 0.875rem;
                background: var(--card-bg);
                font-family: inherit;
            }

            .input-group input:focus, .input-group textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            }

            .mqtt-section {
                background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
                border: 1px solid #bae6fd;
            }

            .mqtt-section .input-row {
                margin-bottom: 12px;
            }

            .mqtt-section .input-row:last-child {
                margin-bottom: 0;
            }

            .mqtt-section .input-label {
                display: block;
                font-size: 0.75rem;
                font-weight: 600;
                color: #0369a1;
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .mqtt-section input, .mqtt-section textarea {
                width: 100%;
                padding: 10px 14px;
                border: 1px solid #7dd3fc;
                border-radius: 8px;
                font-size: 0.875rem;
                background: white;
            }

            .mqtt-section textarea {
                min-height: 80px;
                resize: vertical;
                font-family: 'Monaco', 'Consolas', monospace;
                font-size: 0.8rem;
            }

            .btn-mqtt {
                width: 100%;
                padding: 12px;
                background: linear-gradient(135deg, #0284c7, #0369a1);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                margin-top: 12px;
            }

            .btn-mqtt:hover {
                background: linear-gradient(135deg, #0369a1, #075985);
                transform: translateY(-1px);
            }

            .btn-mqtt:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            #mqttStatus {
                margin-top: 10px;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.8rem;
                text-align: center;
            }

            #mqttStatus.success {
                background: #d1fae5;
                color: #065f46;
            }

            #mqttStatus.error {
                background: #fecaca;
                color: #991b1b;
            }

            .btn-send {
                padding: 12px 24px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 0.875rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-send:hover {
                background: var(--primary-hover);
            }

            .json-helper {
                display: flex;
                gap: 6px;
                margin-top: 8px;
                flex-wrap: wrap;
            }

            .json-helper button {
                padding: 4px 10px;
                font-size: 0.7rem;
                background: #e0f2fe;
                border: 1px solid #7dd3fc;
                border-radius: 4px;
                cursor: pointer;
                color: #0369a1;
                transition: all 0.2s;
            }

            .json-helper button:hover {
                background: #bae6fd;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 48px 24px;
                color: var(--text-secondary);
            }

            .empty-state i {
                font-size: 48px;
                margin-bottom: 16px;
                opacity: 0.5;
            }

            /* Pagination Info */
            .table-footer {
                padding: 16px 24px;
                border-top: 1px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .records-info {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            /* Quick Stats in Sidebar */
            .quick-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .quick-stat {
                background: var(--light-bg);
                border-radius: 10px;
                padding: 12px;
                text-align: center;
            }

            .quick-stat .label {
                font-size: 0.7rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .quick-stat .value {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--text-primary);
                margin-top: 4px;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .container {
                    padding: 12px;
                }

                .header {
                    padding: 16px;
                }

                .header h1 {
                    font-size: 1.25rem;
                }

                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .card-header {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .filters-section {
                    width: 100%;
                }

                .filter-group {
                    width: 100%;
                }

                .filter-select {
                    flex: 1;
                }
            }

            /* Loading Animation */
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--light-bg);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
        </style>
    </head>
    <body>
        <script>
            var allData = []; // Almacenar todos los datos para filtrar
            var currentSensorType = 'weather'; // Tipo de sensor actual
            var currentSort = { column: 'date', direction: 'desc' };

            $(document).ready(function ()
            {
                // Inicializar filtros para el tipo por defecto (weather)
                updateFilters('weather');
                updateTableHeaders('weather');
                
                checkSystemStatus();
                loadData();
                // Auto-refresh cada 30 segundos
                setInterval(function() {
                    loadData();
                    checkSystemStatus();
                }, 30000);
            });

            function checkSystemStatus() {
                $('#systemStatus').removeClass('warning error').addClass('checking');
                $('#statusDot').removeClass('warning error').addClass('checking');
                $('#statusText').text('Verificando...');
                
                $.ajax({
                    url: "/Server/SystemStatus",
                    type: 'get',
                    timeout: 10000,
                    success: function(response) {
                        var status;
                        try {
                            status = typeof response === 'string' ? JSON.parse(response) : response;
                        } catch(e) {
                            showStatusError();
                            return;
                        }
                        
                        updateStatusBadge(status);
                    },
                    error: function() {
                        showStatusError();
                    }
                });
            }

            function updateStatusBadge(status) {
                var badge = $('#systemStatus');
                var dot = $('#statusDot');
                var text = $('#statusText');
                var details = $('#statusDetails');
                
                badge.removeClass('checking warning error');
                dot.removeClass('checking warning error');
                
                // Actualizar indicadores individuales
                var mqttHtml = status.mqtt 
                    ? '<span class="status-item ok"><i class="fas fa-check"></i> MQTT</span>'
                    : '<span class="status-item fail"><i class="fas fa-times"></i> MQTT</span>';
                var dbHtml = status.database 
                    ? '<span class="status-item ok"><i class="fas fa-check"></i> BD</span>'
                    : '<span class="status-item fail"><i class="fas fa-times"></i> BD</span>';
                
                details.html(mqttHtml + dbHtml);
                
                if (status.overall) {
                    text.text('Sistema Activo');
                } else if (status.mqtt || status.database) {
                    badge.addClass('warning');
                    dot.addClass('warning');
                    text.text('Parcialmente Activo');
                } else {
                    badge.addClass('error');
                    dot.addClass('error');
                    text.text('Sistema Caído');
                }
            }

            function showStatusError() {
                $('#systemStatus').removeClass('checking').addClass('error');
                $('#statusDot').removeClass('checking').addClass('error');
                $('#statusText').text('Sin Conexión');
                $('#statusDetails').html('<span class="status-item fail"><i class="fas fa-times"></i> Error</span>');
            }

            function loadData()
            {
                $.ajax({
                    type: "GET",
                    url: "/Server/GetAllData",
                    dataType: "json",
                    success: function(data) {
                        console.log("Data received:", data);
                        console.log("Current sensor type:", currentSensorType);
                        
                        // Procesar datos según el tipo de sensor actual
                        if (currentSensorType === 'weather' && data.weather) {
                            console.log("Processing weather data:", data.weather);
                            allData = data.weather.map(item => ({
                                sensorId: item.sensorId,
                                timestamp: item.timestamp,
                                temperature: item.temperature,
                                humidity: item.humidity,
                                pressure: item.pressure,
                                altitude: item.altitude
                            }));
                            console.log("Processed allData:", allData);
                        } else if (currentSensorType === 'trafficCounter' && data.trafficCounter) {
                            allData = data.trafficCounter.map(item => ({
                                ...item,
                                date: item.timestamp
                            }));
                        } else if (currentSensorType === 'trafficLight' && data.trafficLight) {
                            allData = data.trafficLight.map(item => ({
                                ...item,
                                currentState: item.currentState ? item.currentState.toUpperCase() : null,
                                date:item.timestamp
                            }));
                        } else if (currentSensorType === 'informationDisplay' && data.informationDisplay) {
                            allData = data.informationDisplay.map(item => ({
                                ...item,
                                date: item.timestamp
                            }));
                        } else {
                            allData = [];
                        }
                        
                        updateSensorFilter(allData);
                        updateStats(allData);
                        updateQuickStats(allData);
                        applyFiltersAndRender();
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading data:", error);
                        allData = [];
                        renderTable([]);
                    }
                });
            }

            function updateSensorFilter(data) {
                var sensors = [...new Set(data.map(item => item.sensorId))];
                var select = $('#sensorFilter');
                var currentValue = select.val();
                select.find('option:not(:first)').remove();
                sensors.forEach(function(sensor) {
                    select.append('<option value="' + sensor + '">' + sensor + '</option>');
                });
                if (currentValue) select.val(currentValue);
            }

            function updateStats(data) {
                var statsHtml = '';
                
                if (data.length === 0) {
                    statsHtml = '<div class="stat-card"><div class="icon" style="background: #fee2e2; color: #dc2626;"><i class="fas fa-exclamation-circle"></i></div><div class="label">Sin Datos</div><div class="value">0</div></div>';
                    $('#statsContainer').html(statsHtml);
                    return;
                }

                if (currentSensorType === 'weather') {
                    // Filtrar datos: excluir temperatura=999 (valor null/error), humidity=-1, pressure=-1, altitude=-1
                    var temps = data.map(d => d.temperature).filter(t => t != null && t !== 999);
                    var humidities = data.map(d => d.humidity).filter(h => h != null && h !== -1);
                    var pressures = data.map(d => d.pressure).filter(p => p != null && p !== -1);
                    var altitudes = data.map(d => d.altitude).filter(a => a != null && a !== -1);

                    statsHtml += '<div class="stat-card temp"><div class="icon"><i class="fas fa-thermometer-half"></i></div><div class="label">Temperatura Promedio</div><div class="value">' + 
                                 (temps.length > 0 ? (temps.reduce((a,b) => a+b, 0) / temps.length).toFixed(1) + '°C' : '--') + '</div><div class="sub">Max: ' + 
                                 (temps.length > 0 ? Math.max(...temps).toFixed(1) + '°C' : '--') + ' | Min: ' + 
                                 (temps.length > 0 ? Math.min(...temps).toFixed(1) + '°C' : '--') + '</div></div>';
                    statsHtml += '<div class="stat-card humidity"><div class="icon"><i class="fas fa-tint"></i></div><div class="label">Humedad Promedio</div><div class="value">' + 
                                 (humidities.length > 0 ? (humidities.reduce((a,b) => a+b, 0) / humidities.length).toFixed(1) + '%' : '--') + '</div><div class="sub">Max: ' + 
                                 (humidities.length > 0 ? Math.max(...humidities).toFixed(1) + '%' : '--') + '</div></div>';
                    statsHtml += '<div class="stat-card pressure"><div class="icon"><i class="fas fa-tachometer-alt"></i></div><div class="label">Presión Promedio</div><div class="value">' + 
                                 (pressures.length > 0 ? (pressures.reduce((a,b) => a+b, 0) / pressures.length).toFixed(0) + ' hPa' : '--') + '</div></div>';
                    statsHtml += '<div class="stat-card altitude"><div class="icon"><i class="fas fa-mountain"></i></div><div class="label">Total Registros</div><div class="value">' + data.length + '</div></div>';
                    
                } else if (currentSensorType === 'trafficCounter') {
                    var vehicles = data.map(d => d.vehicleCount || 0);
                    var pedestrians = data.map(d => d.pedestrianCount || 0);
                    var bicycles = data.map(d => d.bicycleCount || 0);
                    var speeds = data.map(d => d.averageSpeedKmh).filter(s => s != null);

                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #dbeafe; color: #2563eb;"><i class="fas fa-car"></i></div><div class="label">Total Vehículos</div><div class="value">' + 
                                 vehicles.reduce((a,b) => a+b, 0) + '</div><div class="sub">Promedio: ' + (vehicles.length > 0 ? (vehicles.reduce((a,b) => a+b, 0) / vehicles.length).toFixed(1) : '0') + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #fef3c7; color: #d97706;"><i class="fas fa-walking"></i></div><div class="label">Total Peatones</div><div class="value">' + 
                                 pedestrians.reduce((a,b) => a+b, 0) + '</div><div class="sub">Promedio: ' + (pedestrians.length > 0 ? (pedestrians.reduce((a,b) => a+b, 0) / pedestrians.length).toFixed(1) : '0') + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #d1fae5; color: #059669;"><i class="fas fa-bicycle"></i></div><div class="label">Total Bicicletas</div><div class="value">' + 
                                 bicycles.reduce((a,b) => a+b, 0) + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #ede9fe; color: #7c3aed;"><i class="fas fa-tachometer-alt"></i></div><div class="label">Velocidad Promedio</div><div class="value">' + 
                                 (speeds.length > 0 ? (speeds.reduce((a,b) => a+b, 0) / speeds.length).toFixed(1) + ' km/h' : '--') + '</div><div class="sub">Registros: ' + data.length + '</div></div>';
                    
                } else if (currentSensorType === 'trafficLight') {
                    var states = {};
                    data.forEach(d => {
                        var state = d.currentState ? d.currentState.toUpperCase() : 'UNKNOWN';
                        states[state] = (states[state] || 0) + 1;
                    });
                    var malfunctions = data.filter(d => d.malfunctionDetected).length;
                    var avgCycle = data.map(d => d.cycleDurationSeconds).filter(c => c != null);

                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #d1fae5; color: #059669;"><i class="fas fa-circle" style="color: #10b981;"></i></div><div class="label">Estado VERDE</div><div class="value">' + 
                                 (states['GREEN'] || 0) + '</div><div class="sub">' + ((states['GREEN'] || 0) / data.length * 100).toFixed(1) + '%</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #fef3c7; color: #d97706;"><i class="fas fa-circle" style="color: #f59e0b;"></i></div><div class="label">Estado AMARILLO</div><div class="value">' + 
                                 (states['YELLOW'] || 0) + '</div><div class="sub">' + ((states['YELLOW'] || 0) / data.length * 100).toFixed(1) + '%</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #fecaca; color: #dc2626;"><i class="fas fa-circle" style="color: #ef4444;"></i></div><div class="label">Estado ROJO</div><div class="value">' + 
                                 (states['RED'] || 0) + '</div><div class="sub">' + ((states['RED'] || 0) / data.length * 100).toFixed(1) + '%</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #fee2e2; color: #991b1b;"><i class="fas fa-exclamation-triangle"></i></div><div class="label">Fallos Detectados</div><div class="value">' + 
                                 malfunctions + '</div><div class="sub">Ciclo Prom: ' + (avgCycle.length > 0 ? (avgCycle.reduce((a,b) => a+b, 0) / avgCycle.length).toFixed(0) + 's' : '--') + '</div></div>';
                    
                } else if (currentSensorType === 'informationDisplay') {
                    var statusCount = {};
                    var contentTypes = {};
                    data.forEach(d => {
                        var st = d.displayStatus || 'UNKNOWN';
                        statusCount[st] = (statusCount[st] || 0) + 1;
                        var ct = d.contentType || 'UNKNOWN';
                        contentTypes[ct] = (contentTypes[ct] || 0) + 1;
                    });
                    var avgBrightness = data.map(d => d.brightnessLevel).filter(b => b != null);
                    var avgEnergy = data.map(d => d.energyConsumptionWatts).filter(e => e != null);

                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #d1fae5; color: #059669;"><i class="fas fa-power-off"></i></div><div class="label">Pantallas ON</div><div class="value">' + 
                                 (statusCount['ON'] || 0) + '</div><div class="sub">OFF: ' + (statusCount['OFF'] || 0) + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #fef3c7; color: #d97706;"><i class="fas fa-sun"></i></div><div class="label">Brillo Promedio</div><div class="value">' + 
                                 (avgBrightness.length > 0 ? (avgBrightness.reduce((a,b) => a+b, 0) / avgBrightness.length).toFixed(0) + '%' : '--') + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #dbeafe; color: #2563eb;"><i class="fas fa-bolt"></i></div><div class="label">Consumo Promedio</div><div class="value">' + 
                                 (avgEnergy.length > 0 ? (avgEnergy.reduce((a,b) => a+b, 0) / avgEnergy.length).toFixed(1) + ' W' : '--') + '</div></div>';
                    statsHtml += '<div class="stat-card"><div class="icon" style="background: #ede9fe; color: #7c3aed;"><i class="fas fa-database"></i></div><div class="label">Total Registros</div><div class="value">' + 
                                 data.length + '</div><div class="sub">Tipos: ' + Object.keys(contentTypes).length + '</div></div>';
                }
                
                $('#statsContainer').html(statsHtml);
            }

            function applyFiltersAndRender() {
                var filtered = [...allData];
                
                // Filtrar por sensor
                var sensorFilter = $('#sensorFilter').val();
                if (sensorFilter) {
                    filtered = filtered.filter(d => d.sensorId == sensorFilter);
                }

                // Filtros específicos por tipo de sensor
                if (currentSensorType === 'weather') {
                    var minTemp = parseFloat($('#minTempFilter').val());
                    if (!isNaN(minTemp)) {
                        filtered = filtered.filter(d => d.temperature >= minTemp);
                    }
                    var maxTemp = parseFloat($('#maxTempFilter').val());
                    if (!isNaN(maxTemp)) {
                        filtered = filtered.filter(d => d.temperature <= maxTemp);
                    }
                    var minHumidity = parseFloat($('#minHumidityFilter').val());
                    if (!isNaN(minHumidity)) {
                        filtered = filtered.filter(d => d.humidity >= minHumidity);
                    }
                } else if (currentSensorType === 'trafficCounter') {
                    var minVehicle = parseInt($('#minVehicleFilter').val());
                    if (!isNaN(minVehicle)) {
                        filtered = filtered.filter(d => (d.vehicleCount || 0) >= minVehicle);
                    }
                    var directionFilter = $('#directionFilter').val();
                    if (directionFilter) {
                        filtered = filtered.filter(d => (d.direction || '').toUpperCase() === directionFilter);
                    }
                    var densityFilter = $('#densityFilter').val();
                    if (densityFilter) {
                        filtered = filtered.filter(d => (d.trafficDensity || '').toUpperCase() === densityFilter);
                    }
                } else if (currentSensorType === 'trafficLight') {
                    var stateFilter = $('#stateFilter').val();
                    if (stateFilter) {
                        filtered = filtered.filter(d => (d.currentState || '').toUpperCase() === stateFilter);
                    }
                    var malfunctionFilter = $('#malfunctionFilter').val();
                    if (malfunctionFilter) {
                        var isMalfunction = malfunctionFilter === 'true';
                        filtered = filtered.filter(d => d.malfunctionDetected === isMalfunction);
                    }
                } else if (currentSensorType === 'informationDisplay') {
                    var displayStatusFilter = $('#displayStatusFilter').val();
                    if (displayStatusFilter) {
                        filtered = filtered.filter(d => (d.displayStatus || '').toUpperCase() === displayStatusFilter);
                    }
                    var contentTypeFilter = $('#contentTypeFilter').val();
                    if (contentTypeFilter) {
                        filtered = filtered.filter(d => (d.contentType || '').toUpperCase() === contentTypeFilter);
                    }
                    var minBrightness = parseInt($('#minBrightnessFilter').val());
                    if (!isNaN(minBrightness)) {
                        filtered = filtered.filter(d => (d.brightnessLevel || 0) >= minBrightness);
                    }
                }

                // Ordenar
                filtered.sort(function(a, b) {
                    var valA = a[currentSort.column];
                    var valB = b[currentSort.column];
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    if (currentSort.direction === 'asc') {
                        return valA > valB ? 1 : -1;
                    } else {
                        return valA < valB ? 1 : -1;
                    }
                });

                renderTable(filtered);
                updateFilteredStats(filtered);
            }
            
            // Nuevas funciones de filtro rápido
            function showHighTraffic() {
                $('#minVehicleFilter').val('20');
                $('#densityFilter').val('HIGH');
                applyFiltersAndRender();
            }
            
            function showMalfunctions() {
                $('#malfunctionFilter').val('true');
                applyFiltersAndRender();
            }

            function updateFilteredStats(data) {
                $('#filteredCount').text(data.length + ' de ' + allData.length + ' registros');
            }

            function changeSensorType(type) {
                currentSensorType = type;
                $('.btn-sensor-type').removeClass('active');
                $('#btn-' + type).addClass('active');
                
                // Actualizar título de la tabla
                var titles = {
                    'weather': '<i class="fas fa-cloud-sun"></i> Datos de Sensores Meteorológicos',
                    'trafficCounter': '<i class="fas fa-car"></i> Datos de Contadores de Tráfico',
                    'trafficLight': '<i class="fas fa-traffic-light"></i> Datos de Semáforos',
                    'informationDisplay': '<i class="fas fa-tv"></i> Datos de Pantallas de Información'
                };
                $('#tableTitle').html(titles[type] || '<i class="fas fa-table"></i> Datos de Sensores');
                
                // Mostrar/ocultar controles de alerta según el tipo
                if (type === 'weather') {
                    $('#weatherControlsCard').show();
                } else {
                    $('#weatherControlsCard').hide();
                }
                
                // Actualizar encabezados de tabla según el tipo
                updateTableHeaders(type);
                
                // Actualizar filtros dinámicos
                updateFilters(type);
                
                // Recargar datos
                loadData();
            }
            
            function updateQuickStats(data) {
                var quickStatsHtml = '<div class="quick-stats">';
                
                if (data.length === 0) {
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Sin Datos</div><div class="value">--</div></div>';
                } else if (currentSensorType === 'weather') {
                    // Filtrar datos: excluir temperatura=999 (valor null/error), humidity=-1
                    var temps = data.map(d => d.temperature).filter(t => t != null && t !== 999);
                    var humidities = data.map(d => d.humidity).filter(h => h != null && h !== -1);
                    
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Temp. Máx</div><div class="value" style="color: #dc2626;">' + 
                                      (temps.length > 0 ? Math.max(...temps).toFixed(1) + '°C' : '--') + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Temp. Mín</div><div class="value" style="color: #2563eb;">' + 
                                      (temps.length > 0 ? Math.min(...temps).toFixed(1) + '°C' : '--') + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Humedad Máx</div><div class="value" style="color: #0891b2;">' + 
                                      (humidities.length > 0 ? Math.max(...humidities).toFixed(1) + '%' : '--') + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Registros</div><div class="value" style="color: #059669;">' + 
                                      data.length + '</div></div>';
                } else if (currentSensorType === 'trafficCounter') {
                    var vehicles = data.map(d => d.vehicleCount || 0);
                    var pedestrians = data.map(d => d.pedestrianCount || 0);
                    
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Veh. Total</div><div class="value" style="color: #2563eb;">' + 
                                      vehicles.reduce((a,b) => a+b, 0) + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Peat. Total</div><div class="value" style="color: #d97706;">' + 
                                      pedestrians.reduce((a,b) => a+b, 0) + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Veh. Máx</div><div class="value" style="color: #dc2626;">' + 
                                      (vehicles.length > 0 ? Math.max(...vehicles) : 0) + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Registros</div><div class="value" style="color: #059669;">' + 
                                      data.length + '</div></div>';
                } else if (currentSensorType === 'trafficLight') {
                    var malfunctions = data.filter(d => d.malfunctionDetected).length;
                    var greenCount = data.filter(d => (d.currentState || '').toUpperCase() === 'GREEN').length;
                    var redCount = data.filter(d => (d.currentState || '').toUpperCase() === 'RED').length;
                    
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Estado Verde</div><div class="value" style="color: #10b981;">' + 
                                      greenCount + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Estado Rojo</div><div class="value" style="color: #ef4444;">' + 
                                      redCount + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Fallos</div><div class="value" style="color: #dc2626;">' + 
                                      malfunctions + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Registros</div><div class="value" style="color: #059669;">' + 
                                      data.length + '</div></div>';
                } else if (currentSensorType === 'informationDisplay') {
                    var onCount = data.filter(d => d.displayStatus === 'ON').length;
                    var avgBrightness = data.map(d => d.brightnessLevel).filter(b => b != null);
                    
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Encendidas</div><div class="value" style="color: #10b981;">' + 
                                      onCount + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Apagadas</div><div class="value" style="color: #64748b;">' + 
                                      (data.length - onCount) + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Brillo Prom</div><div class="value" style="color: #d97706;">' + 
                                      (avgBrightness.length > 0 ? (avgBrightness.reduce((a,b) => a+b, 0) / avgBrightness.length).toFixed(0) + '%' : '--') + '</div></div>';
                    quickStatsHtml += '<div class="quick-stat"><div class="label">Registros</div><div class="value" style="color: #059669;">' + 
                                      data.length + '</div></div>';
                }
                
                quickStatsHtml += '</div>';
                $('#quickStatsBody').html(quickStatsHtml);
            }
            
            function updateFilters(type) {
                var filtersHtml = '<div class="filter-group"><label>Sensor:</label><select class="filter-select" id="sensorFilter" onchange="applyFiltersAndRender()"><option value="">Todos</option></select></div>';
                
                if (type === 'weather') {
                    filtersHtml += '<div class="filter-group"><label>Temp Min:</label><input type="number" class="filter-input" id="minTempFilter" placeholder="°C" onchange="applyFiltersAndRender()" style="width: 80px;"></div>';
                    filtersHtml += '<div class="filter-group"><label>Temp Max:</label><input type="number" class="filter-input" id="maxTempFilter" placeholder="°C" onchange="applyFiltersAndRender()" style="width: 80px;"></div>';
                    filtersHtml += '<div class="filter-group"><label>Humedad Min:</label><input type="number" class="filter-input" id="minHumidityFilter" placeholder="%" onchange="applyFiltersAndRender()" style="width: 80px;"></div>';
                    filtersHtml += '<button class="btn-filter" onclick="showHighTemps()"><i class="fas fa-temperature-high"></i> Temp. Altas</button>';
                    filtersHtml += '<button class="btn-filter" onclick="showLowTemps()"><i class="fas fa-temperature-low"></i> Temp. Bajas</button>';
                } else if (type === 'trafficCounter') {
                    filtersHtml += '<div class="filter-group"><label>Vehículos Min:</label><input type="number" class="filter-input" id="minVehicleFilter" placeholder="#" onchange="applyFiltersAndRender()" style="width: 80px;"></div>';
                    filtersHtml += '<div class="filter-group"><label>Dirección:</label><select class="filter-select" id="directionFilter" onchange="applyFiltersAndRender()"><option value="">Todas</option><option value="NORTH">Norte</option><option value="SOUTH">Sur</option><option value="EAST">Este</option><option value="WEST">Oeste</option></select></div>';
                    filtersHtml += '<div class="filter-group"><label>Densidad:</label><select class="filter-select" id="densityFilter" onchange="applyFiltersAndRender()"><option value="">Todas</option><option value="LOW">Baja</option><option value="MEDIUM">Media</option><option value="HIGH">Alta</option></select></div>';
                    filtersHtml += '<button class="btn-filter" onclick="showHighTraffic()"><i class="fas fa-exclamation-triangle"></i> Tráfico Alto</button>';
                } else if (type === 'trafficLight') {
                    filtersHtml += '<div class="filter-group"><label>Estado:</label><select class="filter-select" id="stateFilter" onchange="applyFiltersAndRender()"><option value="">Todos</option><option value="GREEN">Verde</option><option value="YELLOW">Amarillo</option><option value="RED">Rojo</option></select></div>';
                    filtersHtml += '<div class="filter-group"><label>Fallos:</label><select class="filter-select" id="malfunctionFilter" onchange="applyFiltersAndRender()"><option value="">Todos</option><option value="true">Con fallos</option><option value="false">Sin fallos</option></select></div>';
                    filtersHtml += '<button class="btn-filter" onclick="showMalfunctions()"><i class="fas fa-exclamation-circle"></i> Solo Fallos</button>';
                } else if (type === 'informationDisplay') {
                    filtersHtml += '<div class="filter-group"><label>Estado:</label><select class="filter-select" id="displayStatusFilter" onchange="applyFiltersAndRender()"><option value="">Todos</option><option value="ON">Encendidas</option><option value="OFF">Apagadas</option></select></div>';
                    filtersHtml += '<div class="filter-group"><label>Tipo:</label><select class="filter-select" id="contentTypeFilter" onchange="applyFiltersAndRender()"><option value="">Todos</option><option value="TEXT">Texto</option><option value="IMAGE">Imagen</option><option value="VIDEO">Video</option></select></div>';
                    filtersHtml += '<div class="filter-group"><label>Brillo Min:</label><input type="number" class="filter-input" id="minBrightnessFilter" placeholder="%" onchange="applyFiltersAndRender()" style="width: 80px;"></div>';
                }
                
                filtersHtml += '<button class="btn-filter" onclick="clearFilters()"><i class="fas fa-times"></i> Limpiar</button>';
                $('#filtersContainer').html(filtersHtml);
            }

            function updateTableHeaders(type) {
                var headers = '';
                if (type === 'weather') {
                    headers = '<tr><th data-column="sensorId" onclick="sortTable(\'sensorId\')">Sensor <i class="fas fa-sort"></i></th>' +
                              '<th data-column="date" onclick="sortTable(\'date\')">Fecha/Hora <i class="fas fa-sort"></i></th>' +
                              '<th data-column="temperature" onclick="sortTable(\'temperature\')">Temperatura <i class="fas fa-sort"></i></th>' +
                              '<th data-column="humidity" onclick="sortTable(\'humidity\')">Humedad <i class="fas fa-sort"></i></th>' +
                              '<th data-column="pressure" onclick="sortTable(\'pressure\')">Presión <i class="fas fa-sort"></i></th>' +
                              '<th data-column="altitude" onclick="sortTable(\'altitude\')">Altitud <i class="fas fa-sort"></i></th></tr>';
                } else if (type === 'trafficCounter') {
                    headers = '<tr><th data-column="sensorId" onclick="sortTable(\'sensorId\')">Sensor <i class="fas fa-sort"></i></th>' +
                              '<th data-column="date" onclick="sortTable(\'date\')">Fecha/Hora <i class="fas fa-sort"></i></th>' +
                              '<th data-column="vehicleCount" onclick="sortTable(\'vehicleCount\')">Vehículos <i class="fas fa-sort"></i></th>' +
                              '<th data-column="pedestrianCount" onclick="sortTable(\'pedestrianCount\')">Peatones <i class="fas fa-sort"></i></th>' +
                              '<th data-column="bicycleCount" onclick="sortTable(\'bicycleCount\')">Bicicletas <i class="fas fa-sort"></i></th>' +
                              '<th data-column="direction" onclick="sortTable(\'direction\')">Dirección <i class="fas fa-sort"></i></th>' +
                              '<th data-column="averageSpeedKmh" onclick="sortTable(\'averageSpeedKmh\')">Vel. Media <i class="fas fa-sort"></i></th>' +
                              '<th data-column="trafficDensity" onclick="sortTable(\'trafficDensity\')">Densidad <i class="fas fa-sort"></i></th></tr>';
                } else if (type === 'trafficLight') {
                    headers = '<tr><th data-column="sensorId" onclick="sortTable(\'sensorId\')">Sensor <i class="fas fa-sort"></i></th>' +
                              '<th data-column="date" onclick="sortTable(\'date\')">Fecha/Hora <i class="fas fa-sort"></i></th>' +
                              '<th data-column="currentState" onclick="sortTable(\'currentState\')">Estado <i class="fas fa-sort"></i></th>' +
                              '<th data-column="timeRemainingSeconds" onclick="sortTable(\'timeRemainingSeconds\')">Tiempo Rest. <i class="fas fa-sort"></i></th>' +
                              '<th data-column="cycleDurationSeconds" onclick="sortTable(\'cycleDurationSeconds\')">Duración Ciclo <i class="fas fa-sort"></i></th>' +
                              '<th data-column="circulationDirection" onclick="sortTable(\'circulationDirection\')">Dirección <i class="fas fa-sort"></i></th>' +
                              '<th data-column="pedestrianWaiting" onclick="sortTable(\'pedestrianWaiting\')">Peatones <i class="fas fa-sort"></i></th>' +
                              '<th data-column="malfunctionDetected" onclick="sortTable(\'malfunctionDetected\')">Fallo <i class="fas fa-sort"></i></th></tr>';
                } else if (type === 'informationDisplay') {
                    headers = '<tr><th data-column="sensorId" onclick="sortTable(\'sensorId\')">Sensor <i class="fas fa-sort"></i></th>' +
                              '<th data-column="date" onclick="sortTable(\'date\')">Fecha/Hora <i class="fas fa-sort"></i></th>' +
                              '<th data-column="displayStatus" onclick="sortTable(\'displayStatus\')">Estado <i class="fas fa-sort"></i></th>' +
                              '<th data-column="currentMessage" onclick="sortTable(\'currentMessage\')">Mensaje <i class="fas fa-sort"></i></th>' +
                              '<th data-column="contentType" onclick="sortTable(\'contentType\')">Tipo Contenido <i class="fas fa-sort"></i></th>' +
                              '<th data-column="brightnessLevel" onclick="sortTable(\'brightnessLevel\')">Brillo <i class="fas fa-sort"></i></th>' +
                              '<th data-column="displayType" onclick="sortTable(\'displayType\')">Tipo Pantalla <i class="fas fa-sort"></i></th>' +
                              '<th data-column="energyConsumptionWatts" onclick="sortTable(\'energyConsumptionWatts\')">Consumo <i class="fas fa-sort"></i></th></tr>';
                }
                $('#tableHeader').html(headers);
            }

            function renderTable(data) {
                $("#dataTable").empty();
                if (data.length === 0) {
                    var colspan = currentSensorType === 'weather' ? 6 : 8;
                    $("#dataTable").append('<tr><td colspan="' + colspan + '" class="empty-state"><i class="fas fa-database"></i><p>No hay datos disponibles</p></td></tr>');
                    return;
                }
                var newRow = "";
                $.each(data, function (i, value)
                {
                    if (currentSensorType === 'weather') {
                        var tempClass = 'temp-value';
                        var temp = value.temperature != null ? value.temperature : 0;
                        if (temp > 30) tempClass += ' temp-high';
                        else if (temp < 15) tempClass += ' temp-low';
                        
                        // Si temperatura es 999 (valor de error), mostrar como N/A
                        var tempDisplay = (value.temperature != null && value.temperature !== 999) 
                            ? value.temperature.toFixed(2) + " °C" 
                            : '<span style="color: #94a3b8;">N/A</span>';

                        newRow += "<tr>";
                        newRow += "<td><span class='sensor-badge'><i class='fas fa-thermometer-half'></i>" + (value.sensorId || 'N/A') + "</span></td>";
                        newRow += "<td>" + (value.date || 'N/A') + "</td>";
                        newRow += "<td class='" + tempClass + "'>" + tempDisplay + "</td>";
                        newRow += "<td class='humidity-value'>" + (value.humidity != null && value.humidity !== -1 ? value.humidity.toFixed(2) : '--') + " %</td>";
                        newRow += "<td class='pressure-value'>" + (value.pressure != null && value.pressure !== -1 ? value.pressure.toFixed(2) : '--') + " hPa</td>";
                        newRow += "<td class='altitude-value'>" + (value.altitude != null && value.altitude !== -1 ? value.altitude.toFixed(2) : '--') + " m</td>";
                        newRow += "</tr>";
                    } else if (currentSensorType === 'trafficCounter') {
                        newRow += "<tr>";
                        newRow += "<td><span class='sensor-badge'><i class='fas fa-car'></i>" + value.sensorId + "</span></td>";
                        newRow += "<td>" + value.date + "</td>";
                        newRow += "<td>" + (value.vehicleCount || 0) + "</td>";
                        newRow += "<td>" + (value.pedestrianCount || 0) + "</td>";
                        newRow += "<td>" + (value.bicycleCount || 0) + "</td>";
                        newRow += "<td>" + (value.direction || 'N/A') + "</td>";
                        newRow += "<td>" + (value.averageSpeedKmh ? value.averageSpeedKmh.toFixed(1) + " km/h" : 'N/A') + "</td>";
                        newRow += "<td>" + (value.trafficDensity || 'N/A') + "</td>";
                        newRow += "</tr>";
                    } else if (currentSensorType === 'trafficLight') {
                        newRow += "<tr>";
                        newRow += "<td><span class='sensor-badge'><i class='fas fa-traffic-light'></i>" + value.sensorId + "</span></td>";
                        newRow += "<td>" + value.date + "</td>";
                        newRow += "<td><strong>" + (value.currentState || 'N/A') + "</strong></td>";
                        newRow += "<td>" + (value.timeRemainingSeconds || 0) + "s</td>";
                        newRow += "<td>" + (value.cycleDurationSeconds || 0) + "s</td>";
                        newRow += "<td>" + (value.circulationDirection || 'N/A') + "</td>";
                        newRow += "<td>" + (value.pedestrianWaiting ? 'Sí' : 'No') + "</td>";
                        newRow += "<td>" + (value.malfunctionDetected ? '<span style="color:red">Sí</span>' : 'No') + "</td>";
                        newRow += "</tr>";
                    } else if (currentSensorType === 'informationDisplay') {
                        newRow += "<tr>";
                        newRow += "<td><span class='sensor-badge'><i class='fas fa-tv'></i>" + value.sensorId + "</span></td>";
                        newRow += "<td>" + value.date + "</td>";
                        newRow += "<td>" + (value.displayStatus || 'N/A') + "</td>";
                        newRow += "<td style='max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'>" + (value.currentMessage || 'N/A') + "</td>";
                        newRow += "<td>" + (value.contentType || 'N/A') + "</td>";
                        newRow += "<td>" + (value.brightnessLevel || 0) + "%</td>";
                        newRow += "<td>" + (value.displayType || 'N/A') + "</td>";
                        newRow += "<td>" + (value.energyConsumptionWatts ? value.energyConsumptionWatts.toFixed(1) + " W" : 'N/A') + "</td>";
                        newRow += "</tr>";
                    }
                });
                $("#dataTable").append(newRow);
            }

            function sortTable(column) {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                updateSortIcons();
                applyFiltersAndRender();
            }

            function updateSortIcons() {
                $('th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
                var icon = currentSort.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
                $('th[data-column="' + currentSort.column + '"] i').removeClass('fa-sort').addClass(icon);
            }

            function clearFilters() {
                // Limpiar todos los filtros comunes
                $('#sensorFilter').val('');
                
                // Limpiar filtros específicos de weather
                $('#minTempFilter').val('');
                $('#maxTempFilter').val('');
                $('#minHumidityFilter').val('');
                
                // Limpiar filtros de trafficCounter
                $('#minVehicleFilter').val('');
                $('#directionFilter').val('');
                $('#densityFilter').val('');
                
                // Limpiar filtros de trafficLight
                $('#stateFilter').val('');
                $('#malfunctionFilter').val('');
                
                // Limpiar filtros de informationDisplay
                $('#displayStatusFilter').val('');
                $('#contentTypeFilter').val('');
                $('#minBrightnessFilter').val('');
                
                applyFiltersAndRender();
            }

            function showHighTemps() {
                $('#minTempFilter').val('25');
                $('#maxTempFilter').val('');
                applyFiltersAndRender();
            }

            function showLowTemps() {
                $('#minTempFilter').val('');
                $('#maxTempFilter').val('18');
                applyFiltersAndRender();
            }

            function insertData()
            {
                var value = $('#newValue').val();
                $.ajax(
                {
                    data: {value: value},
                    url: "/Server/SetData",
                    type: 'post',
                    async: false,
                    success: function (response)
                    {
                        loadData();
                    }
                });
            }

            function publishMQTT() {
                var topic = $('#mqttTopic').val().trim();
                var message = $('#mqttMessage').val().trim();
                
                if (!topic) {
                    showMqttStatus('Error: El topic es requerido', false);
                    return;
                }
                
                if (!message) {
                    showMqttStatus('Error: El mensaje es requerido', false);
                    return;
                }
                
                // Validar que sea JSON válido
                try {
                    JSON.parse(message);
                } catch(e) {
                    showMqttStatus('Error: El mensaje debe ser JSON válido', false);
                    return;
                }
                
                $('#btnPublishMqtt').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Enviando...');
                
                $.ajax({
                    url: "/Server/PublishMQTT",
                    type: 'post',
                    data: { topic: topic, message: message },
                    success: function(response) {
                        var resp;
                        try {
                            resp = typeof response === 'string' ? JSON.parse(response) : response;
                        } catch(e) {
                            showMqttStatus('Error al parsear respuesta', false);
                            resetMqttButton();
                            return;
                        }
                        
                        if (resp.success) {
                            showMqttStatus('✓ Mensaje enviado a: ' + topic, true);
                        } else {
                            showMqttStatus('✗ Error: ' + resp.error, false);
                            showMqttStatus("EL topic es: " + JSON.stringify(resp), false);
                        }
                        resetMqttButton();
                    },
                    error: function() {
                        showMqttStatus('✗ Error de conexión con el servidor', false);
                        resetMqttButton();
                    }
                });
            }

            function showMqttStatus(message, success) {
                var status = $('#mqttStatus');
                status.removeClass('success error').addClass(success ? 'success' : 'error');
                status.html(message);
                setTimeout(function() { status.html('').removeClass('success error'); }, 5000);
            }

            function resetMqttButton() {
                $('#btnPublishMqtt').prop('disabled', false).html('<i class="fas fa-paper-plane"></i> Publicar Mensaje');
            }

            function insertJsonTemplate(template) {
                var templates = {
                    'weather': '{\n' +
            '  "sensor_id": "LAB08JAV-G1",\n' +
            '  "timestamp": "2025-12-01 18:30:00:000",\n' +
            '  "sensor_type": "weather",\n' +
            '  "location": {\n' +
            '    "altitude_meters": 650.0\n' +
            '  },\n' +
            '  "data": {\n' +
            '    "temperature_celsius": 25.5,\n' +
            '    "humidity_percent": 60.0,\n' +
            '    "atmospheric_pressure_hpa": 1013.25\n' +
            '  }\n' +
            '}',
            'traffic': '{\n' +
            '  "sensor_id": "LAB08JAV-G1",\n' +
            '  "timestamp": "2025-11-28 10:15:00:000",\n' +
            '  "sensor_type": "traffic_counter",\n' +
            '  "location": {\n' +
            '    "altitude_meters": 650\n' +
            '  },\n' +
            '  "data": {\n' +
            '    "vehicle_count": 55,\n' +
            '    "pedestrian_count": 200,\n' +
            '    "bicycle_count": 15,\n' +
            '    "direction": "west",\n' +
            '    "counter_type": "mixed",\n' +
            '    "technology": "infrared",\n' +
            '    "average_speed_kmh": 35.5,\n' +
            '    "occupancy_percentage": 85,\n' +
            '    "traffic_density": "medium"\n' +
            '  }\n' +
            '}',
            'light': '{\n' +
            '  "sensor_id": "LAB08JAV-G2",\n' +
            '  "timestamp": "2025-11-28 10:16:00:000",\n' +
            '  "sensor_type": "traffic_light",\n' +
            '  "data": {\n' +
            '    "current_state": "red",\n' +
            '    "cycle_position_seconds": 30,\n' +
            '    "time_remaining_seconds": 60,\n' +
            '    "cycle_duration_seconds": 120,\n' +
            '    "traffic_light_type": "pedestrian_vehicle",\n' +
            '    "circulation_direction": "unidirectional",\n' +
            '    "pedestrian_waiting": true,\n' +
            '    "pedestrian_button_pressed": true,\n' +
            '    "malfunction_detected": false,\n' +
            '    "cycle_count": 15,\n' +
            '    "state_changed": false,\n' +
            '    "last_state_change": "2025-11-28T10:00:00.000000"\n' +
            '  }\n' +
            '}',
            'display': '{\n' +
            '  "sensor_id": "LAB08JAV-G3",\n' +
            '  "timestamp": "2025-11-28 10:17:00:000",\n' +
            '  "sensor_type": "information_display",\n' +
            '  "data": {\n' +
            '    "display_status": "active",\n' +
            '    "current_message": "Trafico fluido en zona centro",\n' +
            '    "content_type": "traffic",\n' +
            '    "brightness_level": 90,\n' +
            '    "display_type": "led_matrix",\n' +
            '    "display_size_inches": 42.0,\n' +
            '    "supports_color": true,\n' +
            '    "temperature_celsius": 35.5,\n' +
            '    "energy_consumption_watts": 120.0,\n' +
            '    "last_content_update": "2025-11-28T10:01:30.000000"\n' +
            '  }\n' +
            '}',
            'alert': '{\n  "alert_level": 1,\n}',
            'command': '{\n  "command": "restart"\n}'
                };
                $('#mqttMessage').val(templates[template] || '{}');
            }

            function formatJson() {
                var textarea = $('#mqttMessage');
                var value = textarea.val().trim();
                try {
                    var parsed = JSON.parse(value);
                    textarea.val(JSON.stringify(parsed, null, 2));
                } catch(e) {
                    showMqttStatus('Error: JSON inválido', false);
                }
            }

            function sendAlertLevel(level) {
    console.log("Enviando nivel: " + level); // 1. Verificamos que la función arranca

    $.ajax({
        data: { alert_level: level },
        url: "/Server/SendCommand", 
        type: 'post',
        success: function (response) {
            console.log("Respuesta bruta del servidor:", response); // 2. Verificamos qué llega

            var resp = response;
            
            // CORRECCIÓN CLAVE: Solo parseamos si es texto. Si ya es objeto, lo usamos tal cual.
            if (typeof response === "string") {
                try {
                    resp = JSON.parse(response);
                } catch (e) {
                    console.error("Error parseando JSON:", e);
                    $('#commandStatus').html('<span style="color:red;">Error de datos recibidos</span>');
                    return;
                }
            }

            // Ahora validamos la lógica
            if (resp.success) {
                $('#commandStatus').html('<span style="color:green;">✓ Alerta nivel ' + level + ' enviada</span>');
            } else {
                // Usamos JSON.stringify por si resp.error es un objeto complejo
                var errorMsg = (typeof resp.error === 'object') ? JSON.stringify(resp.error) : resp.error;
                $('#commandStatus').html('<span style="color:red;">✗ Error: ' + errorMsg + '</span>');
            }

            setTimeout(function() { $('#commandStatus').html(''); }, 3000);
        },
        error: function(xhr, status, error) {
            console.error("Error AJAX:", status, error);
            $('#commandStatus').html('<span style="color:red;">✗ Error de conexión (' + status + ')</span>');
        }
    });
}

            function sendReset()
            {
                if (confirm('¿Estás seguro de que quieres reiniciar el dispositivo?')) {
                    $.ajax(
                    {
                        data: {command: 'reset'},
                        url: "/Server/SendCommand",
                        type: 'post',
                        success: function (response)
                        {
                            var resp = response;
                            if (resp.success) {
                                $('#commandStatus').html('<span style="color:green;">✓ Comando de reset enviado</span>');
                            } else {
                                $('#commandStatus').html('<span style="color:red;">✗ Error: ' + resp.error + '</span>');
                            }
                            setTimeout(function() { $('#commandStatus').html(''); }, 3000);
                        },
                        error: function() {
                            $('#commandStatus').html('<span style="color:red;">✗ Error de conexión</span>');
                        }
                    });
                }
            }

        </script>

        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <div class="logo">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <div>
                        <h1>Panel de Control IoT</h1>
                        <p>Monitorización de Sensores Ambientales</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-container">
                        <div class="status-badge checking" id="systemStatus" onclick="checkSystemStatus()" title="Click para actualizar estado">
                            <span class="status-dot checking" id="statusDot"></span>
                            <span id="statusText">Verificando...</span>
                        </div>
                        <div class="status-details" id="statusDetails"></div>
                    </div>
                    <button class="btn-refresh" onclick="loadData(); checkSystemStatus();">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
            </header>

            <!-- Selector de Tipo de Sensor - PROMINENTE -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h2 class="card-title" style="color: white;">
                        <i class="fas fa-layer-group"></i>
                        Selecciona el Tipo de Sensor a Visualizar
                    </h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <button class="btn-alert btn-sensor-type active" id="btn-weather" onclick="changeSensorType('weather')" 
                                style="padding: 28px 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 1rem; cursor: pointer;">
                            <i class="fas fa-cloud-sun" style="font-size: 2.2rem; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600;">Meteorológico</span>
                            <small style="opacity: 0.9; font-size: 0.8rem; margin-top: 4px;">Temp, Humedad, Presión</small>
                        </button>
                        <button class="btn-alert btn-sensor-type" id="btn-trafficCounter" onclick="changeSensorType('trafficCounter')" 
                                style="padding: 24px 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.95rem; cursor: pointer;">
                            <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600;">Contador Tráfico</span>
                            <small style="opacity: 0.9; font-size: 0.75rem; margin-top: 4px;">Vehículos, Peatones</small>
                        </button>
                        <button class="btn-alert btn-sensor-type" id="btn-trafficLight" onclick="changeSensorType('trafficLight')" 
                                style="padding: 24px 16px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; font-size: 0.95rem; cursor: pointer;">
                            <i class="fas fa-traffic-light" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600;">Semáforos</span>
                            <small style="opacity: 0.9; font-size: 0.75rem; margin-top: 4px;">Estados, Ciclos</small>
                        </button>
                        <button class="btn-alert btn-sensor-type" id="btn-informationDisplay" onclick="changeSensorType('informationDisplay')" 
                                style="padding: 24px 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; font-size: 0.95rem; cursor: pointer;">
                            <i class="fas fa-tv" style="font-size: 2rem; margin-bottom: 8px;"></i>
                            <span style="font-weight: 600;">Pantallas Info</span>
                            <small style="opacity: 0.9; font-size: 0.75rem; margin-top: 4px;">Displays, Mensajes</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards - Dinámicas según tipo de sensor -->
            <div class="stats-grid" id="statsContainer">
                <!-- Se llenarán dinámicamente según el tipo de sensor -->
            </div>

            <!-- Main Content -->
            <div class="main-grid">
                <!-- Data Table Section - ahora ocupa todo el ancho de la grid -->
                    <div class="card table-card">
                    <div class="card-header" style="padding: 24px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <h2 class="card-title" id="tableTitle" style="color: white; font-size: 1.5rem;">
                            <i class="fas fa-cloud-sun"></i>
                            Datos de Sensores Meteorológicos
                        </h2>
                        <button class="btn-refresh" onclick="loadData()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    
                    <div class="card-body" style="padding: 0;">
                        <!-- Filters Dinámicos -->
                        <div class="filters-section" style="padding: 20px; border-bottom: 1px solid var(--border-color);" id="filtersContainer">
                            <!-- Se llenarán dinámicamente según el tipo de sensor -->
                        </div>
                        
                        <!-- Table -->
                        <div class="table-container">
                            <table>
                                <thead id="tableHeader">
                                    <tr>
                                        <th data-column="sensorId" onclick="sortTable('sensorId')">
                                            Sensor ID <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-column="date" onclick="sortTable('date')">
                                            Fecha <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-column="temperature" onclick="sortTable('temperature')">
                                            Temperatura <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-column="humidity" onclick="sortTable('humidity')">
                                            Humedad <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-column="pressure" onclick="sortTable('pressure')">
                                            Presión <i class="fas fa-sort"></i>
                                        </th>
                                        <th data-column="altitude" onclick="sortTable('altitude')">
                                            Altitud <i class="fas fa-sort"></i>
                                        </th>
                                    </tr>
                                </thead>
                            <tbody id="dataTable">
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="records-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="filteredCount">0 registros</span>
                        </div>
                        <div>
                            <small>Auto-refresh: 30s</small>
                        </div>
                    </div>
                </div>

                <!-- Sidebar - Controls -->
                <div>
                    <!-- Quick Stats - Siempre visible -->
                    <div class="card" style="margin-bottom: 20px;" id="quickStatsCard">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Estadísticas Rápidas
                            </h2>
                        </div>
                        <div class="card-body" id="quickStatsBody">
                            <!-- Se llenarán dinámicamente -->
                        </div>
                    </div>

                    <!-- Alert Controls - Solo para Weather -->
                    <div class="card" id="weatherControlsCard" style="display: block;">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-bell"></i>
                                Control de Alertas ESP32
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="alert-section">
                                <div class="alert-title">Nivel de Alerta</div>
                                <div class="alert-buttons">
                                    <button class="btn-alert level-0" onclick="sendAlertLevel(0)">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Nivel 0</span>
                                        <small>Sin Alerta</small>
                                    </button>
                                    <button class="btn-alert level-1" onclick="sendAlertLevel(1)">
                                        <i class="fas fa-info-circle"></i>
                                        <span>Nivel 1</span>
                                        <small>Baja</small>
                                    </button>
                                    <button class="btn-alert level-2" onclick="sendAlertLevel(2)">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span>Nivel 2</span>
                                        <small>Media</small>
                                    </button>
                                    <button class="btn-alert level-3" onclick="sendAlertLevel(3)">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Nivel 3</span>
                                        <small>Alta</small>
                                    </button>
                                    <button class="btn-alert level-4" onclick="sendAlertLevel(4)">
                                        <i class="fas fa-radiation"></i>
                                        <span>Nivel 4</span>
                                        <small>Crítica</small>
                                    </button>
                                </div>
                            </div>

                            <button class="btn-reset" onclick="sendReset()">
                                <i class="fas fa-redo-alt"></i>
                                Reiniciar Dispositivo
                            </button>

                            <div id="commandStatus"></div>
                        </div>
                    </div>
                    
                    <!-- MQTT Publisher - Siempre visible -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header" style="background: linear-gradient(135deg, #0284c7, #0369a1); color: white;">
                            <h2 class="card-title" style="color: white;">
                                <i class="fas fa-paper-plane"></i>
                                Publicar Mensaje MQTT
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="input-section mqtt-section">
                                <div class="input-row">
                                    <label class="input-label">Topic MQTT</label>
                                    <input type="text" id="mqttTopic" placeholder="ej: sensors/ST_1617/weather_station/LAB08JAV-G5" value="sensors/ST_1617/weather_station/LAB08JAV-G5">
                                </div>
                                <div class="input-row">
                                    <label class="input-label">Mensaje JSON</label>
                                    <textarea id="mqttMessage" placeholder='{"sensorId": "SENSOR_001", "temperature": 25.5}'></textarea>
                                    <div class="json-helper">
                                        <button onclick="insertJsonTemplate('weather')">Weather</button>
                                        <button onclick="insertJsonTemplate('traffic')">Traffic</button>
                                        <button onclick="insertJsonTemplate('light')">Light</button>
                                        <button onclick="insertJsonTemplate('display')">Display</button>
                                        <button onclick="formatJson()">Format</button>
                                    </div>
                                </div>
                                <button class="btn-mqtt" id="btnPublishMqtt" onclick="publishMQTT()">
                                    <i class="fas fa-paper-plane"></i>
                                    Publicar Mensaje
                                </button>
                                <div id="mqttStatus"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>